name: Issue Query Trigger

on:
  issues:
    types: [opened, labeled]

jobs:
  trigger-query:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: write
      contents: read
    
    steps:
      - name: Check if issue is a query submission
        id: check
        run: |
          ISSUE_BODY='${{ github.event.issue.body }}'
          ISSUE_TITLE='${{ github.event.issue.title }}'
          
          # Check if this is a query submission by looking for the marker text
          if echo "$ISSUE_BODY" | grep -q "MorphoSource Query Submission"; then
            echo "is_query=true" >> $GITHUB_OUTPUT
            echo "This is a query submission issue"
          elif echo "$ISSUE_TITLE" | grep -q "^Query:"; then
            echo "is_query=true" >> $GITHUB_OUTPUT
            echo "This is a query submission issue (detected by title)"
          else
            echo "is_query=false" >> $GITHUB_OUTPUT
            echo "This is not a query submission issue, skipping"
          fi
      
      - name: Extract query from issue
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        if: steps.check.outputs.is_query == 'true'
        run: |
          # Extract query from issue body
          # Try to extract the query between "**Query:**" and "---"
          QUERY=$(echo "$ISSUE_BODY" | sed -n '/\*\*Query:\*\*/,/---/p' | sed '1d;$d' | tr '\n' ' ' | xargs)
          
          # If extraction failed, use the entire body
          if [ -z "$QUERY" ]; then
            QUERY=$(echo "$ISSUE_BODY" | head -n 100 | tr '\n' ' ' | xargs)
          fi
          
          echo "query=$QUERY" >> $GITHUB_OUTPUT
          echo "Extracted query: $QUERY"
      
      - name: Add query-request label
        if: steps.check.outputs.is_query == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Add the query-request label if not already present
            const labels = context.payload.issue.labels.map(l => l.name);
            if (!labels.includes('query-request')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['query-request']
              });
              console.log('Added query-request label');
            }
      
      - name: Add comment to issue
        if: steps.check.outputs.is_query == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'üîÑ **Query received!**\n\nYour query is being processed. Results will be posted here shortly.\n\n‚è≥ Status: Processing...'
            });
      
      - name: Trigger query processor workflow
        env:
          QUERY_TEXT: ${{ steps.extract.outputs.query }}
        if: steps.check.outputs.is_query == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const query = process.env.QUERY_TEXT;
            
            try {
              const response = await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'query-processor.yml',
                ref: 'main',
                inputs: {
                  query: query,
                  issue_number: context.issue.number.toString()
                }
              });
              
              console.log('Workflow triggered successfully');
              
              // Add comment with link to workflow
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚úÖ **Query processor started!**\n\nView the workflow run progress here:\n[GitHub Actions](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/query-processor.yml)\n\nResults will be posted as a comment once processing is complete.`
              });
              
              // Store issue number in workflow metadata for later reference
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['query-request', 'processing']
              });
              
            } catch (error) {
              console.error('Error triggering workflow:', error);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå **Error triggering query processor**\n\n${error.message}\n\nPlease try manually triggering the workflow at:\n[Query Processor Workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/query-processor.yml)`
              });
              
              throw error;
            }
